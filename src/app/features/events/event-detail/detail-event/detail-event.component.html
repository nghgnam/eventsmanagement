@if (event) {
  <div class="details_container">
    <!-- Hero Section with Background Image -->
    <div class="events_background">
        <div class="events_background2" [style.background-image]="'url(' + (getSafeUrl(event.image_url) || getDefaultImageUrl()) + ')'"></div>
        <img [src]="getSafeUrl(event.image_url)" [alt]="event.name" class="background_details" appImageErrorHandler>
    </div>

    <!-- Main Content -->
    <div class="events_details">
        <!-- Event Information -->
        <div class="event_infomation">
            <!-- Event Date and Title -->
            <div class="event_header">
                <div class="event_date">
                    <i class="fa-solid fa-calendar-days"></i>
                    <span>{{ showStartTime | date: 'EEEE, MMMM d' }}</span>
                </div>
                <h1 class="event_title">{{ event.name }}</h1>
                <div class="event_type_badge" 
                     [class.online]="event.event_type === 'online'"
                     [class.offline]="event.event_type === 'offline'"
                     [class.hybrid]="event.event_type === 'hybrid'">
                    <i class="fa-solid" 
                       [class.fa-video]="event.event_type === 'online'"
                       [class.fa-location-dot]="event.event_type === 'offline'"
                       [class.fa-desktop]="event.event_type === 'hybrid'"></i>
                    {{ event.event_type }}
                </div>
            </div>

            <!-- Organizer Info -->
            @if (event.organizer) {
              <div class="about_organizer">
                  <div class="organizer_avatar">
                      @if (getSafeUrl(event.organizer.profileImage); as SafeUrl) {
                        <img
                            [src]="SafeUrl || 'https://res.cloudinary.com/dpiqldk0y/image/upload/v1744575077/default-avatar_br3ffh.png'"
                            [alt]="event.organizer.name">
                      }
                  </div>
                  <div class="organizer_info">
                      <div class="organizer_info_header">
                          <span class="organizer_by_label">By</span>
                          <p class="organizer_name">{{ event.organizer.name }}</p>
                      </div>
                      <div class="organizer_info_footer">
                          <span class="organizer_followers_count">{{ event.organizer.followers }}</span>
                          <span class="organizer_followers_label">followers</span>
                      </div>
                  </div>
                  <button (click)="actionFollow()" [disabled]="isFollowLoading || isOrganizer" [class.active]="hasFollow"
                      class="organizer_follow">
                      @if (!isFollowLoading) {
                        {{ hasFollow ? 'Hủy theo dõi' : 'Theo dõi' }}
                      } @else {
                        Đang xử lý...
                      }
                  </button>
              </div>
            }

            <!-- Event Description -->
            <div class="event_description">
                <p>{{ event.description }}</p>
            </div>

            <!-- Date and Time Selection -->
            <div class="section_title">
                <h2>Select Date & Time</h2>
                <p class="section_subtitle">Choose your preferred event schedule</p>
            </div>
            <div class="event_date_time_options">
                <div class="selected_date_and_time">
                    <div class="selected_date_icon">
                        <i class="fa-solid fa-calendar-days"></i>
                    </div>
                    <div class="selected_date_text">
                        <h3>Selected Schedule</h3>
                        <p>{{ showStartTime | date : "EEEE, MMMM d, y" }}</p>
                        <p class="time_range">{{ showStartTime | date : "h:mm a" }} - {{showEndTime | date : "h:mm a"}}
                        </p>
                    </div>
                </div>
                <div class="selected_date_and_time_container">
                    <h3 class="available_schedules">Available Schedules</h3>
                    <div class="date_time_options_grid">
                        @for (datetime of event.date_time_options; track datetime.start_time; let i = $index) {
                          <div class="selected_options_date_and_time" 
                               (click)="getDatetimeClick(i)" 
                               [class.active]="activeBorder === i">
                            <div class="date_time_card">
                                <div class="date_time_header">
                                    <span class="date_day">{{ datetime.start_time | date : "EEEE"}}</span>
                                    <span class="date_month">{{ datetime.start_time | date : "MMMM"}}</span>
                                </div>
                                <div class="date_time_body">
                                    <span class="date_number" [class.selected]="isClickActive === i">{{ datetime.start_time | date : "d"}}</span>
                                    <span class="date_year">{{ datetime.start_time | date : "y"}}</span>
                                </div>
                                <div class="date_time_footer">
                                    <i class="fa-regular fa-clock"></i>
                                    <span class="time">{{ datetime.start_time | date : "h:mm a" }}</span>
                                </div>
                            </div>
                          </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Location -->
            <div class="section_title">
                <h2>Location</h2>
            </div>
            <div class="event_location">
                <i class="fa-solid" [class.fa-video]="event.location.type === 'online'" [class.fa-location-dot]="event.location.type === 'offline'"></i>
                <span>{{ event.location.type === 'online' ? 'Online Event' : event.location.address }}</span>
            </div>

            <!-- About Event -->
            <div class="section_title">
                <h2>About this event</h2>
            </div>
            <div class="event_about">
                <p>{{event.content}}</p>
            </div>

            <!-- Tags -->
            @if (event.tags && event.tags.length > 0) {
              <div class="section_title">
                <h2>Tags</h2>
              </div>
              <div class="event_tag">
                @for (tag of event.tags; track tag) {
                  <p>{{tag}}</p>
                }
              </div>
            }

            <!-- Organizer Details -->
            @if (event.organizer) {
              <div class="section_title">
                  <h2>Organized by</h2>
              </div>
              <div class="host_organized_about">
                  <div class="host_header">
                      @if (getSafeUrl(event.organizer.profileImage); as SafeUrl) {
                        <img
                            [src]="SafeUrl || 'https://res.cloudinary.com/dpiqldk0y/image/upload/v1744575077/default-avatar_br3ffh.png'"
                            [alt]="event.organizer.name" class="host_avatar">
                      }
                      <div class="host_info">
                          <p class="host_name">{{event.organizer.name}}</p>
                          <p class="host_follower">{{event.organizer.followers}} followers</p>
                      </div>
                  </div>
                  <p class="host_about">This is About Organized</p>
              </div>
            }

            <!-- More Events from Organizer -->
            @if (events$ | async; as events) {
              @if (getOtherEventsFromOrganizer(events).length > 0) {
                <div class="section_title">
                  <h2>More events from this organizer</h2>
                </div>
                <div class="events_other">
                  @for (e of getOtherEventsFromOrganizer(events); track e.id) {
                    <div class="event_other_block" (click)="goToDetail(e.id)">
                      <div class="event_other_image">
                        @if (getSafeUrl(e.image_url); as SafeUrl) {
                          <img [src]="SafeUrl" [alt]="e.name" appImageErrorHandler>
                        } @else {
                          <img [src]="getDefaultImageUrl()" [alt]="e.name" appImageErrorHandler>
                        }
                        <div class="event_other_date">
                          <span class="day">{{e.date_time_options[0]?.start_time | date : "d"}}</span>
                          <span class="month">{{e.date_time_options[0]?.start_time | date : "MMM"}}</span>
                        </div>
                      </div>
                      <div class="event_other_info">
                        <h3 class="event_other_title">{{e.name}}</h3>
                        <p class="event_other_time">
                          <i class="fa-solid fa-clock"></i>
                          {{e.date_time_options[0]?.start_time | date : "EEEE MMMM d, y 'at' h:mm a"}}
                        </p>
                        <p class="event_other_price">
                          {{e.price && e.price > 0 ? (e.price | currency:'VND':'symbol':'1.0-0') : 'Free'}}
                        </p>
                        @if (e.organizer) {
                          <p class="event_other_organizer">
                            <i class="fa-solid fa-user"></i>
                            {{e.organizer.name}}
                          </p>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            }
        </div>

        <!-- Ticket Purchase Section -->
        <div class="event_ticket">
            <div class="get_ticket">
                <app-ticket-selection
                    [event]="event"
                    (ticketsSelected)="onTicketsSelected($event)"
                    (buyNow)="onBuyNow($event)">
                </app-ticket-selection>
            </div>
        </div>
    </div>
  </div>

  <!-- Order Review Popup -->
  <app-popup
    title="Xác nhận đơn hàng"
    width="90vw"
    height="90vh"
    [(isVisible)]="showOrderReviewPopup">
    @if (showOrderReviewPopup) {
      <app-order-review-popup
        [event]="event"
        [selectedTickets]="selectedTickets"
        (proceedToPayment)="onProceedToPayment($event)"
        (cancel)="onOrderReviewCancel()">
      </app-order-review-popup>
    }
  </app-popup>

  <!-- Payment Method Popup -->
  <app-popup
    title="Chọn phương thức thanh toán"
    width="90vw"
    height="90vh"
    [(isVisible)]="showPaymentMethodPopup">
    @if (showPaymentMethodPopup) {
      <app-payment-method-popup
        [totalAmount]="totalAmount"
        (methodSelected)="onPaymentMethodSelected($event)"
        (cancel)="onPaymentMethodCancel()">
      </app-payment-method-popup>
    }
  </app-popup>

  <!-- QR Payment Popup -->
  <app-popup
    title="Thanh toán qua QR Code"
    width="90vw"
    height="90vh"
    [(isVisible)]="showQRPaymentPopup">
    @if (showQRPaymentPopup) {
      <app-qr-payment-popup
        [orderId]="currentOrderId"
        [amount]="totalAmount"
        (paymentConfirmed)="onQRPaymentConfirmed()"
        (cancel)="onQRPaymentCancel()">
      </app-qr-payment-popup>
    }
  </app-popup>

  <!-- Payment Result Popup -->
  <app-popup
    [title]="paymentResult === 'success' ? 'Thanh toán thành công' : 'Kết quả thanh toán'"
    width="90vw"
    height="90vh"
    [(isVisible)]="showPaymentResultPopup">
    @if (showPaymentResultPopup) {
      <app-payment-result-popup
        [result]="paymentResult"
        [message]="paymentResultMessage"
        [orderId]="currentOrderId"
        (close)="onPaymentResultClose()"
        (viewTickets)="onPaymentResultViewTickets()"
        (goHome)="onPaymentResultGoHome()"
        (retry)="onPaymentResultRetry()">
      </app-payment-result-popup>
    }
  </app-popup>
}
