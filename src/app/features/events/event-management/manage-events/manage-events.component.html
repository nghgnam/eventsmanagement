<div class="brower-event-container">
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <span>Event Management</span>
            </div>
            <div class="user-info">
                <img [src]="sanitizeImageUrl(currentUser?.profileImage)" alt="User Avatar" class="avatar">
                <div>
                    <h4 class="username">{{currentUser?.fullName}}</h4>
                    <p class="role">{{currentUser?.role}}</p>
                </div>
            </div>
            <div class="menu">
                <ul>
                    <li [class.active]="activeTab === 'upcoming'" (click)="setActiveTab('upcoming')">
                        <span>Upcoming Events</span>
                    </li>
                    <li [class.active]="activeTab === 'past'" (click)="setActiveTab('past')">
                        <span>Past Events</span>
                    </li>

                    <li [class.active]="activeTab === 'delete'" (click)="setActiveTab('delete')" >
                        <span>Cancelled Events</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            

            <!-- Header -->
            <div class="header">
                <h2>
                    {{activeTab === 'upcoming' ? 'Upcoming Events' : 'Past Events'}}
                </h2>
                <button class="create-event-btn" (click)="openCreateEventPopup()" >
                    Create New Event
                </button>
            </div>

            <!-- Alert Messages -->
            @if (errorMessage) {
              <div class="alert alert-error">
                {{errorMessage}}
              </div>
            }
            @if (successMessage) {
              <div class="alert alert-success">
                {{successMessage}}
              </div>
            }

            <!-- Create Event Form -->
            <app-popup
              title="Create New Event"
              width="90vw"
              height="90vh"
              [(isVisible)]="showCreateEventPopup">
              @if (showCreateEventPopup) {
                <app-create-event
                  [currentUser]="currentUser"
                  (cancelled)="closeCreateEventPopup()"
                  (created)="handleCreateSuccess($event)"
                  (createError)="handleCreateError($event)">
                </app-create-event>
              }
            </app-popup>

            <!-- Edit Event Form -->
            <app-popup
              title="Edit Event"
              width="90vw"
              height="90vh"
              [(isVisible)]="showEditEventPopup">
              @if (showEditEventPopup && eventToEdit) {
                <app-edit-event
                  [eventId]="eventToEdit.id"
                  (cancelled)="closeEditEventPopup()"
                  (updated)="handleEditSuccess($event)"
                  (updateError)="handleEditError($event)">
                </app-edit-event>
              }
            </app-popup>

            <!-- Events List -->
            @if (!showCreateEventPopup) {
              <div class="card events-list">
                @if (isLoading) {
                  <div class="loading-spinner">
                    Loading events...
                  </div>
                }
                
                @if (!isLoading) {
                  <div class="events-grid">
                    @for (event of getFilteredEvents(); track event.id) {
                      <div class="event-card">
                        @if (event.image_url) {
                          <div class="event-image">
                            <img [src]="event.image_url" alt="Event image">
                          </div>
                        }
                        <div class="event-header">
                            <h3>{{event.name}}</h3>
                            <span class="event-status" [class]="getEventStatus(event).toLowerCase()">
                                {{getEventStatus(event)}}
                            </span>
                        </div>
                        <div class="event-details">
                            <p class="event-description">{{event.description}}</p>
                            <div class="event-info">
                                <div class="info-item">
                                    <span class="material-icons">schedule</span>
                                    <span>Start: {{formatDate(event.date_time_options[0].start_time)}}</span>
                                </div>
                                <div class="info-item">
                                    <span class="material-icons">location_on</span>
                                    <span>{{event.location.type === 'online' ? 'Online Event' : event.location.address}}</span>
                                </div>
                                <div class="info-item">
                                    <span class="material-icons">groups</span>
                                    <span>{{event.attendees_count || 0}} / {{event.max_attendees || 'Unlimited'}} attendees</span>
                                </div>
                                @if (event.price) {
                                  <div class="info-item">
                                    <span>Price: ${{event.price}}</span>
                                  </div>
                                }
                            </div>
                            <div class="event-actions">
                              @if (getEventStatus(event) !== 'Past') {
                                <button class="btn-edit" (click)="editEvent(event)">
                                  <span class="material-icons">edit</span> Edit
                                </button>
                              }
                              @if (getEventStatus(event) !== 'Cancelled') {
                                <button class="btn-delete" (click)="confirmDelete(event)">
                                  <span class="material-icons">delete</span> Delete
                                </button>
                              }
                              @if (getEventStatus(event) === 'Cancelled') {
                                <button class="btn-restore" (click)="restoreEvent(event)">
                                  <span class="material-icons">restore</span> Restore
                                </button>
                              }
                              <button class="btn-dashboard" (click)="goToDashboard(event)">
                                <span class="material-icons">insights</span> Dashboard
                              </button>
                            </div>
                        </div>
                      </div>
                    }
                  </div>
                }

                @if (!isLoading && getFilteredEvents().length === 0) {
                  <div class="no-events">
                    <p>No {{activeTab}} events found.</p>
                  </div>
                }
              </div>
            }
        </div>
    </div>
</div>